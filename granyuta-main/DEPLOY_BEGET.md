# Инструкция по деплою на Beget

## Подготовка

### 1. Подключение к серверу Beget через SSH

```bash
ssh ваш_логин@ваш_сервер.beget.tech
# или
ssh ваш_логин@IP_адрес
```

### 2. Проверка наличия Node.js, PM2 и Python

```bash
node --version  # Должна быть версия 18+
npm --version
pm2 --version   # Если нет, установите: npm install -g pm2
python3 --version  # Нужен для обновления БД
```

Если PM2 не установлен:
```bash
npm install -g pm2
```

Если Python не установлен, установите через панель Beget или обратитесь в поддержку.

## Вариант 1: Загрузка через FTP/SFTP (если нет SSH доступа)

1. **Подключитесь к серверу через FTP клиент** (FileZilla, WinSCP и т.д.)
   - Хост: ваш_домен.beget.tech или IP адрес
   - Порт: 21 (FTP) или 22 (SFTP)
   - Логин и пароль от панели Beget

2. **Загрузите все файлы проекта** в директорию `public_html` или `www` (зависит от настроек Beget)

3. **Подключитесь по SSH** и выполните команды из Варианта 2

## Вариант 2: Загрузка через Git (если есть репозиторий)

```bash
# Подключитесь по SSH
ssh ваш_логин@ваш_сервер.beget.tech

# Перейдите в директорию сайта
cd ~/ваш_домен/public_html
# или
cd ~/www/ваш_домен

# Клонируйте репозиторий (если используете Git)
git clone https://github.com/ваш_репозиторий/granyuta.git .

# Или обновите существующий
git pull origin main
```

## Вариант 3: Загрузка через SCP (прямая загрузка файлов)

С вашего локального компьютера:

```bash
# Загрузите всю папку проекта
scp -r granyuta-main/* ваш_логин@ваш_сервер.beget.tech:~/public_html/

# Или через WinSCP / FileZilla (SFTP режим)
```

## Настройка на сервере

### 1. Перейдите в директорию проекта

```bash
cd ~/public_html
# или
cd ~/www/ваш_домен
```

### 2. Создайте файл конфигурации .env

```bash
cp config/env.example config/.env
nano config/.env
```

Заполните переменные:
```env
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ваш_chat_id
PORT=3000
NODE_ENV=production
CORS_ORIGIN=https://granyuta.ru
```

Сохраните файл (Ctrl+O, Enter, Ctrl+X в nano)

### 3. Установите зависимости

```bash
npm ci --only=production
```

### 4. Создайте директорию для логов

```bash
mkdir -p logs
```

### 5. Запустите деплой

```bash
chmod +x deploy.sh
./deploy.sh
```

Или вручную:

```bash
# Остановите предыдущий процесс (если был)
pm2 stop granyuta 2>/dev/null || true
pm2 delete granyuta 2>/dev/null || true

# Запустите приложение
pm2 start ecosystem.config.js --env production

# Сохраните конфигурацию PM2
pm2 save

# Настройте автозапуск при перезагрузке сервера
pm2 startup
# Выполните команду, которую выведет PM2
```

## Настройка Nginx на Beget (если нужен прокси)

Beget обычно использует свою панель управления для настройки Nginx. Но если нужна ручная настройка:

1. **Через панель Beget** настройте проксирование на порт 3000
2. Или создайте файл `.htaccess` (если используется Apache)

## Проверка работы

```bash
# Проверьте статус
pm2 status

# Посмотрите логи
pm2 logs granyuta

# Проверьте health endpoint
curl http://localhost:3000/api/health
```

## Полезные команды PM2

```bash
pm2 status              # Статус всех процессов
pm2 logs granyuta       # Просмотр логов
pm2 restart granyuta    # Перезапуск
pm2 stop granyuta       # Остановка
pm2 delete granyuta     # Удаление из PM2
pm2 monit               # Мониторинг в реальном времени
pm2 save                # Сохранить текущую конфигурацию
```

## Обновление проекта

Когда нужно обновить код:

```bash
# 1. Загрузите новые файлы (через Git, FTP или SCP)

# 2. Подключитесь по SSH
ssh ваш_логин@ваш_сервер.beget.tech

# 3. Перейдите в директорию проекта
cd ~/public_html

# 4. Обновите зависимости (если изменились)
npm ci --only=production

# 5. Перезапустите приложение
pm2 restart granyuta

# Или используйте скрипт деплоя
./deploy.sh
```

## Решение проблем

### Порт 3000 занят
```bash
# Проверьте, что использует порт
lsof -i :3000
# Или измените PORT в config/.env
```

### PM2 не запускается
```bash
# Проверьте логи
pm2 logs granyuta --lines 50

# Проверьте права доступа
chmod +x server.js
chmod +x deploy.sh
```

### База данных не найдена
```bash
# Убедитесь, что файл db/baths.db существует
ls -la db/baths.db

# Если нет, создайте БД через Python скрипт
cd db
python3 init_db.py
# Выберите опцию 1 (Обычное обновление) или 2 (Принудительное пересоздание)
```

## Важные замечания для Beget

1. **Порт**: Beget может ограничивать доступные порты. Уточните в поддержке, какие порты доступны
2. **Node.js версия**: Убедитесь, что на сервере установлена Node.js 18+
3. **PM2 автозапуск**: После `pm2 startup` выполните команду, которую выведет PM2
4. **Доменное имя**: Настройте домен через панель Beget, чтобы он указывал на ваш проект

